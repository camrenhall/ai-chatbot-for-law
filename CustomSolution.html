<!DOCTYPE html>
<html>
<head>
  <title>Law Firm Chatbot Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="background-color: #f5f6f7; margin: 0; padding: 0; font-family: Arial, sans-serif;">
  <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <header style="background-color: #1a365d; color: white; padding: 20px; border-radius: 8px;">
      <h1>Roth Davies Personal Injury Law</h1>
      <p>Experienced Attorneys Fighting For Your Rights</p>
    </header>
    
    <div style="background-color: white; margin-top: 20px; padding: 30px; border-radius: 8px; min-height: 400px;">
      <h2>Personal Injury Services</h2>
      <p>This is a demo page to showcase the chatbot functionality. In a real implementation, this would be the law firm's actual website content.</p>
      <p>Try clicking the chat bubble in the bottom right corner to test the chatbot!</p>
    </div>
  </div>

  <!-- Custom Personal Injury Law Firm Chatbot -->
<script>
(function() {
  // Create the chatbot styles - professional and branded for a law firm
  const style = document.createElement('style');
  style.textContent = `
    /* Chatbot Container Styles */
    .law-chat-widget {
      font-family: 'Arial', sans-serif;
      position: fixed;
      z-index: 9999;
    }
    
    /* Chat Bubble - Enhanced with glowing effect and text */
    .law-chat-bubble {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background-color: #1a365d;
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 9999;
      animation: pulse 2s infinite;
    }
    
    /* Pulsing animation for the chat bubble */
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(26, 54, 93, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(26, 54, 93, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(26, 54, 93, 0);
      }
    }
    
    /* Text Us label for the chat bubble */
    .law-chat-bubble::before {
      content: "Text Us";
      position: absolute;
      top: -40px;
      background-color: #1a365d;
      color: white;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      white-space: nowrap;
      animation: float 3s ease-in-out infinite;
    }
    
    /* Floating animation for the "Text Us" label */
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
    }
    
    .law-chat-bubble:hover {
      transform: scale(1.1);
    }
    
    .law-chat-bubble-icon {
      color: white;
      font-size: 24px;
    }
    
    /* Chat Window */
    .law-chat-window {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 380px;
      height: 580px;
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15), 0 0 1px rgba(0,0,0,0.3);
      overflow: hidden;
      display: none;
      flex-direction: column;
      z-index: 9998;
      transition: all 0.3s ease;
      border: none;
    }
    
    /* Chat Header */
    .law-chat-header {
      background: linear-gradient(135deg, #1a365d 0%, #0d2b4e 100%);
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .law-chat-title {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      letter-spacing: 0.5px;
    }
    
    .law-chat-title-icon {
      margin-right: 12px;
      font-size: 20px;
    }
    
    .law-chat-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      font-size: 18px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0.9;
      transition: all 0.2s ease;
    }
    
    .law-chat-close:hover {
      opacity: 1;
      background: rgba(255,255,255,0.2);
      transform: rotate(90deg);
    }
    
    /* Chat Messages Area */
    .law-chat-messages {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      background-color: #f8f9fa;
      scroll-behavior: smooth;
    }
    
    .law-chat-messages::-webkit-scrollbar {
      width: 6px;
    }
    
    .law-chat-messages::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    .law-chat-messages::-webkit-scrollbar-thumb {
      background: #c5cfd9;
      border-radius: 3px;
    }
    
    /* Video as part of a message */
    .law-chat-video {
      width: 100%;
      height: auto;
      max-width: 100%;
      border-radius: 8px;
      margin-top: 8px;
      margin-bottom: 8px;
    }
    
    /* Message Bubbles */
    .law-chat-message {
      margin-bottom: 14px;
      max-width: 85%;
      display: flex;
      flex-direction: column;
    }
    
    .law-chat-message-user {
      align-self: flex-end;
    }
    
    .law-chat-message-bot {
      align-self: flex-start;
    }
    
    .law-chat-bubble-content {
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.5;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .law-chat-message-user .law-chat-bubble-content {
      background-color: #dbe9ff;
      color: #1a365d;
      border-bottom-right-radius: 4px;
    }
    
    .law-chat-message-bot .law-chat-bubble-content {
      background-color: white;
      color: #333;
      border: 1px solid #e1e5e9;
      border-bottom-left-radius: 4px;
    }
    
    /* Option Bubbles */
    .law-chat-options {
      display: flex;
      flex-wrap: wrap;
      margin-top: 10px;
      gap: 8px;
    }
    
    .law-chat-option {
      background-color: #f0f4f8;
      border: 1px solid #c5cfd9;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      color: #1a365d;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .law-chat-option:hover {
      background-color: #e4ecf7;
      border-color: #1a365d;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .law-chat-option:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .law-chat-time {
      font-size: 11px;
      color: #9aa5b1;
      margin-top: 4px;
      margin-left: 6px;
      margin-right: 6px;
    }
    
    /* Typing Indicator */
    .law-chat-typing {
      display: none;
      margin: 10px 0 14px 20px; /* Added left margin to align with other messages */
    }
    
    .law-chat-typing-dots {
      display: flex;
      align-items: center;
    }
    
    .law-chat-dot {
      width: 8px;
      height: 8px;
      background-color: #9aa5b1;
      border-radius: 50%;
      margin: 0 4px;
      animation: law-chat-typing 1.4s infinite ease-in-out;
    }
    
    .law-chat-dot:nth-child(1) { animation-delay: 0s; }
    .law-chat-dot:nth-child(2) { animation-delay: 0.2s; }
    .law-chat-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes law-chat-typing {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    
    /* Input Area */
    .law-chat-input-container {
      padding: 15px;
      background-color: white;
      border-top: 1px solid #e1e5e9;
      display: flex;
      align-items: center;
    }
    
    .law-chat-input {
      flex-grow: 1;
      padding: 12px 16px;
      border: 1px solid #dfe3e8;
      border-radius: 24px;
      font-size: 15px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      resize: none;
      overflow: hidden;
      height: 24px; /* Exact height for a single line of text */
      max-height: 120px;
      line-height: 24px; /* Match height for single line text */
    }
    
    .law-chat-input:focus {
      border-color: #1a365d;
      box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.15);
    }
    
    .law-chat-send {
      margin-left: 10px;
      width: 44px;
      height: 44px;
      background-color: #1a365d;
      color: white;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(26, 54, 93, 0.2);
    }
    
    .law-chat-send:hover {
      background-color: #10243d;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(26, 54, 93, 0.3);
    }
    
    .law-chat-send:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(26, 54, 93, 0.2);
    }
    
    .law-chat-send:disabled {
      background-color: #e1e5e9;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .law-chat-send-icon {
      font-size: 18px;
    }
    
    /* Play Button Overlay */
    .law-chat-video-play {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 8px;
    }
    
    .law-chat-video-play-button {
      width: 50px;
      height: 50px;
      background-color: rgba(255,255,255,0.8);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    /* Mobile Responsive */
    @media (max-width: 480px) {
      .law-chat-window {
        width: 90%;
        height: 80%;
        bottom: 80px;
        right: 5%;
        left: 5%;
      }
    }
  `;
  document.head.appendChild(style);
  
  // Create chat elements
  const chatContainer = document.createElement('div');
  chatContainer.className = 'law-chat-widget';
  
  // Chat bubble
  const chatBubble = document.createElement('div');
  chatBubble.className = 'law-chat-bubble';
  chatBubble.innerHTML = '<div class="law-chat-bubble-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 13.5997 2.37562 15.1116 3.04346 16.4525C3.22094 16.8088 3.28001 17.2161 3.17712 17.6006L2.58151 19.8267C2.32295 20.793 3.20701 21.677 4.17335 21.4185L6.39939 20.8229C6.78393 20.72 7.19121 20.7791 7.54753 20.9565C8.88837 21.6244 10.4003 22 12 22Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 10.5H16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 14H13.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>';
  
  // Chat window
  const chatWindow = document.createElement('div');
  chatWindow.className = 'law-chat-window';
  
  // Chat header
  const chatHeader = document.createElement('div');
  chatHeader.className = 'law-chat-header';
  chatHeader.innerHTML = `
    <h3 class="law-chat-title">
      <span class="law-chat-title-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 1.5L1.5 6.5L12 11.5L22.5 6.5L12 1.5Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M1.5 17.5L12 22.5L22.5 17.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M1.5 12L12 17L22.5 12" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg></span>
  Roth Davies Assistant
    </h3>
    <button class="law-chat-close">×</button>
  `;
  
  // Chat messages container
  const messagesContainer = document.createElement('div');
  messagesContainer.className = 'law-chat-messages';
  
  // Typing indicator
  const typingIndicator = document.createElement('div');
  typingIndicator.className = 'law-chat-typing';
  typingIndicator.innerHTML = `
    <div class="law-chat-typing-dots">
      <div class="law-chat-dot"></div>
      <div class="law-chat-dot"></div>
      <div class="law-chat-dot"></div>
    </div>
  `;
  
  // Input container
  const inputContainer = document.createElement('div');
  inputContainer.className = 'law-chat-input-container';
  inputContainer.innerHTML = `
    <textarea class="law-chat-input" placeholder="Type your question here..." rows="1"></textarea>
    <button class="law-chat-send" disabled>
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  `;
  
  // Assemble chat window
  chatWindow.appendChild(chatHeader);
  chatWindow.appendChild(messagesContainer);
  chatWindow.appendChild(typingIndicator);
  chatWindow.appendChild(inputContainer);
  
  // Append elements to container and then to body
  chatContainer.appendChild(chatBubble);
  chatContainer.appendChild(chatWindow);
  document.body.appendChild(chatContainer);
  
  // Get DOM elements
  const inputField = document.querySelector('.law-chat-input');
  const sendButton = document.querySelector('.law-chat-send');
  const closeButton = document.querySelector('.law-chat-close');
  
  // File input method for video loading
  function createFileInput() {
    // Create a hidden file input element
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.id = 'law-chat-video-selector';
    fileInput.accept = 'video/*';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
    
    return fileInput;
  }
  
  // Video sources based on page path keywords
  const videoMap = {
    'default': 'welcome.mp4',
    'personal-injury': 'personal-injury.mp4',
    'criminal-defense': 'criminal-defense.mp4',
    'divorce': 'family-law.mp4'
  };
  
  // Create the file input for fallback method
  const videoFileInput = createFileInput();
  
  // Set video source based on current page
  // Get video filename based on current page
  function getVideoFilename() {
    const currentPath = window.location.pathname.toLowerCase();
    let videoFilename = videoMap.default;
    
    if (currentPath.includes('personal-injury')) {
      videoFilename = videoMap['personal-injury'];
    } else if (currentPath.includes('criminal') || currentPath.includes('defense')) {
      videoFilename = videoMap['criminal-defense'];
    } else if (currentPath.includes('divorce') || currentPath.includes('family')) {
      videoFilename = videoMap['divorce'];
    }
    
    return videoFilename;
  }
  
  // Set video source using direct URL method first, with fallback to file input if needed
  function createVideoMessage() {
    const videoFilename = getVideoFilename();
    
    // Create the video message container
    const videoMessage = document.createElement('div');
    videoMessage.className = 'law-chat-message law-chat-message-bot';
    
    // Create the message content container
    const messageContent = document.createElement('div');
    messageContent.className = 'law-chat-bubble-content';
    
    // Create the video element
    const videoElement = document.createElement('video');
    videoElement.className = 'law-chat-video';
    videoElement.controls = true;
    videoElement.autoplay = true;
    videoElement.muted = false; // Allow sound
    videoElement.playsInline = true; // For iOS
    
    // First try with a relative path
    const videoSrc = `videos/${videoFilename}`;
    videoElement.src = videoSrc;
    
    // Add error handling for video loading
    videoElement.onerror = function() {
      console.log("Error loading video with direct path, trying alternate methods...");
      
      // Try with a file URL as fallback (only works on some browsers)
      if (window.location.protocol === 'file:') {
        // For local file testing
        const videoPath = `${window.location.href.substring(0, window.location.href.lastIndexOf('/'))}`;
        const fullPath = `${videoPath}/videos/${videoFilename}`;
        console.log("Trying with file URL:", fullPath);
        videoElement.src = fullPath;
        
        videoElement.onerror = function() {
          // Last resort - show file input on error
          handleVideoLoadError(messageContent, videoElement);
        };
      } else {
        // Last resort - show file input on error
        handleVideoLoadError(messageContent, videoElement);
      }
    };
    
    // Assemble the message
    messageContent.appendChild(videoElement);
    videoMessage.appendChild(messageContent);
    
    // Add time stamp
    const timeStamp = document.createElement('div');
    timeStamp.className = 'law-chat-time';
    timeStamp.textContent = formatTime();
    videoMessage.appendChild(timeStamp);
    
    return videoMessage;
  }
  
  // Handle video load error with file input fallback
  function handleVideoLoadError(container, videoElement) {
    // If we're here, normal loading methods failed
    console.log("Falling back to manual file selection");
    
    // Remove the video element temporarily
    if (videoElement.parentNode === container) {
      container.removeChild(videoElement);
    }
    
    // Display a message and button to select video
    const errorMessage = document.createElement('div');
    errorMessage.innerHTML = `
      <p style="margin-bottom: 10px;">Unable to load the introduction video automatically.</p>
      <button id="select-video-btn" style="padding: 8px 16px; background: #c41230; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Select Video Manually
      </button>
    `;
    container.appendChild(errorMessage);
    
    // Add click event to the button
    setTimeout(() => {
      document.getElementById('select-video-btn').addEventListener('click', function() {
        videoFileInput.click();
      });
      
      // Handle file selection
      videoFileInput.onchange = function() {
        if (this.files && this.files[0]) {
          const objectURL = URL.createObjectURL(this.files[0]);
          
          // Remove the error message
          container.removeChild(errorMessage);
          
          // Reset the video element
          videoElement.src = objectURL;
          container.appendChild(videoElement);
          
          videoElement.load();
          videoElement.play().catch(e => console.log("Autoplay prevented:", e));
        }
      };
    }, 0);
  }
  
  // OpenAI API Key - This should be replaced with a secure backend in production
  // IMPORTANT: Exposing API keys in frontend code is not secure for production
  // This is only for demo purposes
  const OPENAI_API_KEY = "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";
  
  // Chat flow variables
  let chatHistory = [];
  let qualificationStage = 'initial'; // Possible values: initial, caseType, location, qualified
  let userCaseType = null;
  let userLocation = null;
  let videoAdded = false;
  
  // Utility functions
  function formatTime() {
    const now = new Date();
    return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  
  function addMessage(content, isUser, options = null) {
    const messageClass = isUser ? 'law-chat-message-user' : 'law-chat-message-bot';
    const messageTime = formatTime();
    
    const messageElement = document.createElement('div');
    messageElement.className = `law-chat-message ${messageClass}`;
    
    let messageContent = `<div class="law-chat-bubble-content">${content}</div>`;
    
    // Add options if provided (and not a user message)
    if (options && !isUser) {
      messageContent += `
        <div class="law-chat-options">
          ${options.map(option => `<div class="law-chat-option" data-value="${option.value}">${option.text}</div>`).join('')}
        </div>
      `;
    }
    
    messageContent += `<div class="law-chat-time">${messageTime}</div>`;
    messageElement.innerHTML = messageContent;
    
    // Add click event listeners to options
    if (options && !isUser) {
      setTimeout(() => {
        const optionElements = messageElement.querySelectorAll('.law-chat-option');
        optionElements.forEach(optionElement => {
          optionElement.addEventListener('click', function() {
            const selectedValue = this.getAttribute('data-value');
            const selectedText = this.textContent;
            handleOptionSelection(selectedValue, selectedText);
          });
        });
      }, 0);
    }
    
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Update chat history
    if (isUser || !options) {
      chatHistory.push({
        role: isUser ? "user" : "assistant",
        content: content
      });
    }
  }
  
  function handleOptionSelection(value, text) {
    // Add the selected option as a user message
    addMessage(text, true);
    
    // Handle the qualification flow
    if (qualificationStage === 'initial') {
      userCaseType = value;
      qualificationStage = 'caseType';
      
      // Ask for location with buttons
      const isKanasOrMissouri = [
        { value: 'kansas', text: 'Kansas' },
        { value: 'missouri', text: 'Missouri' },
        { value: 'other', text: 'Other State' }
      ];
      addMessage("Thank you. Is your case in Kansas or Missouri?", false, isKanasOrMissouri);
      
    } else if (qualificationStage === 'caseType') {
      userLocation = value;
      qualificationStage = 'location';
      
      if (value === 'kansas' || value === 'missouri') {
        // Qualified - proceed with chat
        qualificationStage = 'qualified';
        addMessage(`Great! I'd be happy to discuss your ${userCaseType} case in ${text}. What specific questions do you have?`, false);
      } else {
        // Not qualified - provide alternate contact
        addMessage("I'm sorry, but our firm only handles cases in Kansas and Missouri. Would you like to speak with one of our attorneys anyway to see if we can refer you to someone in your area?", false, [
          { value: 'yes-referral', text: 'Yes, I\'d like a referral' },
          { value: 'no-thanks', text: 'No, thank you' }
        ]);
      }
    } else if (qualificationStage === 'location' && (value === 'yes-referral' || value === 'no-thanks')) {
      if (value === 'yes-referral') {
        addMessage("Great! Please call our office at (913) 555-7890 and we'll help connect you with an attorney in your area. Is there anything else I can help with?", false);
      } else {
        addMessage("I understand. If you have any other questions or change your mind, please feel free to ask. Is there anything else I can help with?", false);
      }
      // Set as qualified so they can continue chatting if they want
      qualificationStage = 'qualified';
    }
  }
  
  function showTypingIndicator() {
    typingIndicator.style.display = 'flex';
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
  
  function hideTypingIndicator() {
    typingIndicator.style.display = 'none';
  }
  
  async function sendMessageToOpenAI(message) {
    showTypingIndicator();
    
    try {
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${OPENAI_API_KEY}`
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [
            {
              role: "system",
              content: `You are a helpful, friendly assistant for a law firm in Overland Park, Kansas. 
              Your primary job is to provide information about ${userCaseType} cases, the law firm's services, and 
              general guidance. Remember that you cannot provide specific legal advice. Always encourage potential 
              clients to schedule a free consultation for specific case evaluations. The firm specializes in car accidents, 
              truck accidents, slip and fall injuries, workplace injuries, medical malpractice, and wrongful death claims 
              in the area of personal injury, as well as criminal defense and divorce/family law. 
              They work on a contingency fee basis for personal injury cases - no fee unless they win the case. Free consultations are available 
              by calling (913) 555-7890. The client has indicated they have a ${userCaseType} case in ${userLocation}.`
            },
            ...chatHistory
          ],
          temperature: 0.7,
          max_tokens: 500
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      const aiResponse = data.choices[0].message.content;
      
      hideTypingIndicator();
      addMessage(aiResponse, false);
    } catch (error) {
      console.error("Error calling OpenAI API:", error);
      hideTypingIndicator();
      addMessage("I'm sorry, I'm having trouble connecting right now. Please try again or call our office directly at (913) 555-7890.", false);
    }
  }
  
  // Fallback responses for offline demo (if the API key isn't provided)
  const fallbackResponses = {
    "accident": "If you've been in an accident, your health is the first priority. Seek medical attention right away, even if you feel fine - some injuries aren't immediately apparent. Then, document everything you can about the accident and call us at (913) 555-7890 for a free consultation to discuss your legal options.",
    "worth": "Every personal injury case is unique. The value depends on factors like medical expenses, lost wages, pain and suffering, and long-term impacts. We offer a free consultation to evaluate your specific situation and give you a better understanding of what compensation you might expect.",
    "settlement": "Most personal injury cases settle before trial, but we prepare every case as if it will go to court. This approach often leads to better settlement offers. The timeline varies from a few months to over a year depending on case complexity and the extent of your injuries.",
    "fault": "Kansas follows a modified comparative negligence rule, meaning you can still recover damages even if you were partially at fault, as long as your fault is less than 50%. Your compensation may be reduced by your percentage of fault. We can evaluate your situation during a free consultation.",
    "fees": "We work on a contingency fee basis, which means you pay nothing upfront, and we only get paid if we win your case. Our fee is typically a percentage of your settlement or verdict. This arrangement allows anyone to access quality legal representation regardless of their financial situation.",
    "consultation": "We offer a free 30-minute consultation to discuss your case. You can schedule by calling (913) 555-7890. We also offer virtual consultations if that's more convenient for you.",
    "evidence": "Important evidence in personal injury cases includes medical records, accident reports, witness statements, photographs, video footage, and documentation of lost wages. The sooner you contact us, the better we can help preserve crucial evidence for your case.",
    "timeline": "Most personal injury cases resolve within 3-12 months, though complex cases can take longer. We work efficiently to reach a resolution while still pursuing maximum compensation for your injuries."
  };
  
  // Function for using fallback responses if API key isn't available
  function processFallbackResponse(message) {
    showTypingIndicator();
    
    setTimeout(() => {
      hideTypingIndicator();
      
      let response = "Thank you for your question. Our team would be happy to provide more specific information during a free consultation. Would you like us to contact you to schedule a time to talk? You can reach us at (913) 555-7890.";
      
      // Check for keywords in the message
      const lowercaseMessage = message.toLowerCase();
      Object.keys(fallbackResponses).forEach(key => {
        if (lowercaseMessage.includes(key)) {
          response = fallbackResponses[key];
        }
      });
      
      addMessage(response, false);
    }, 1500);
  }
  
  // Event listeners
  inputField.addEventListener('input', () => {
    // Get a precise measurement of text width
    const textLength = inputField.value.length;
    
    // Create a hidden div to measure text width accurately
    const measureText = (text) => {
      const hidden = document.createElement('div');
      hidden.style.position = 'absolute';
      hidden.style.visibility = 'hidden';
      hidden.style.height = 'auto';
      hidden.style.width = 'auto';
      hidden.style.whiteSpace = 'nowrap';
      hidden.style.fontFamily = getComputedStyle(inputField).fontFamily;
      hidden.style.fontSize = getComputedStyle(inputField).fontSize;
      hidden.style.padding = getComputedStyle(inputField).padding;
      hidden.textContent = text;
      document.body.appendChild(hidden);
      const width = hidden.clientWidth;
      document.body.removeChild(hidden);
      return width;
    };
    
    // Calculate available width for text (input width minus padding)
    const inputWidth = inputField.clientWidth - (parseInt(getComputedStyle(inputField).paddingLeft) + parseInt(getComputedStyle(inputField).paddingRight));
    
    // Check if text would overflow a single line
    const textWidth = measureText(inputField.value);
    const hasLineBreaks = inputField.value.includes('\n');
    
    // Expand if text is wider than input or has line breaks
    if (textWidth > inputWidth * 0.9 || hasLineBreaks) {
      // Reset height before calculating to get accurate scrollHeight
      inputField.style.height = '24px';
      
      // Calculate the content height and expand
      const contentHeight = inputField.scrollHeight;
      inputField.style.height = Math.min(contentHeight, 120) + 'px';
    } else {
      // Keep at single line height when text fits
      inputField.style.height = '24px';
    }
    
    // Enable/disable send button based on input
    sendButton.disabled = inputField.value.trim() === '';
  });
  
  sendButton.addEventListener('click', () => {
    const message = inputField.value.trim();
    if (message) {
      addMessage(message, true);
      inputField.value = '';
      inputField.style.height = '24px';
      sendButton.disabled = true;
      
      // Only use OpenAI if user is qualified
      if (qualificationStage === 'qualified') {
        // Uncomment the following line to use OpenAI API
        // sendMessageToOpenAI(message);
        
        // For demo purposes, use fallback responses instead
        processFallbackResponse(message);
      } else if (qualificationStage === 'initial') {
        // If user tries to type before selecting case type, remind them and re-show options
        addMessage("I understand you may have specific questions. To better assist you, please select the type of case you need help with from the options below:", false, [
          { value: 'personal-injury', text: 'Personal Injury' },
          { value: 'criminal-defense', text: 'Criminal Defense' },
          { value: 'divorce', text: 'Divorce' }
        ]);
      } else if (qualificationStage === 'caseType') {
        // If user tries to type before selecting location, remind them and re-show options
        addMessage("Thank you. Before we continue, please let me know if your case is in Kansas or Missouri:", false, [
          { value: 'kansas', text: 'Kansas' },
          { value: 'missouri', text: 'Missouri' },
          { value: 'other', text: 'Other State' }
        ]);
      }
    }
  });
  
  inputField.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (!sendButton.disabled) {
        sendButton.click();
      }
    }
  });
  
  // Play video with sound when chat window opens
  chatBubble.addEventListener('click', () => {
    chatWindow.style.display = 'flex';
    chatBubble.style.display = 'none';
    
    // Start qualification flow if it's the first time opening
    if (chatHistory.length === 0) {
      // Add video message as first message if not already added
      if (!videoAdded) {
        // Add the video message
        const videoMessage = createVideoMessage();
        messagesContainer.appendChild(videoMessage);
        videoAdded = true;
        
        // Wait a bit, then add the initial greeting
        setTimeout(() => {
          // Initial greeting and first qualification question
          addMessage("Hello! I'm your virtual legal assistant. What type of case do you need help with?", false, [
            { value: 'personal-injury', text: 'Personal Injury' },
            { value: 'criminal-defense', text: 'Criminal Defense' },
            { value: 'divorce', text: 'Divorce' }
          ]);
        }, 1000);
      }
    }
  });
  
  closeButton.addEventListener('click', () => {
    chatWindow.style.display = 'none';
    chatBubble.style.display = 'flex';
    
    // Pause any videos that might be playing
    const videos = messagesContainer.querySelectorAll('video');
    videos.forEach(video => video.pause());
  });
})();
</script>
</body>
</html>