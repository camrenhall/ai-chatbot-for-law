<!DOCTYPE html>
<html>
<head>
  <title>Law Firm Chatbot Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="background-color: #f5f6f7; margin: 0; padding: 0; font-family: Arial, sans-serif;">
  <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <header style="background-color: #1a365d; color: white; padding: 20px; border-radius: 8px;">
      <h1>Roth Davies Law Firm</h1>
      <p>Experienced Attorneys Fighting For Your Rights</p>
    </header>
    
    <div style="background-color: white; margin-top: 20px; padding: 30px; border-radius: 8px; min-height: 400px;">
      <h2>Personal Injury Services</h2>
      <p>This is a demo page to showcase the chatbot functionality. In a real implementation, this would be the law firm's actual website content.</p>
      <p>Try clicking the chat bubble in the bottom right corner to test the chatbot!</p>
    </div>
  </div>

  <!-- Custom Personal Injury Law Firm Chatbot -->
<script>
(function() {
  // Create the chatbot styles - professional and branded for a law firm
  const style = document.createElement('style');
  style.textContent = `
    /* Chatbot Container Styles */
    .law-chat-widget {
      font-family: 'Arial', sans-serif;
      position: fixed;
      z-index: 9999;
    }
    
    /* Chat Bubble - Enhanced with glowing effect and text */
    .law-chat-bubble {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background-color: #1a365d;
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 9999;
      animation: pulse 2s infinite;
    }
    
    /* Pulsing animation for the chat bubble */
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(26, 54, 93, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(26, 54, 93, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(26, 54, 93, 0);
      }
    }
    
    /* Text Us label for the chat bubble */
    .law-chat-bubble::before {
      content: "Text Us!";
      position: absolute;
      top: -40px;
      background-color: #1a365d;
      color: white;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      white-space: nowrap;
      animation: float 3s ease-in-out infinite;
    }

    /* Notification Thing */
    .law-chat-notification {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 20px;
      height: 20px;
      background-color: #e74c3c;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      animation: bounce 1s infinite alternate;
      z-index: 10000;
    }

    @keyframes bounce {
      from {
        transform: scale(1);
      }
      to {
        transform: scale(1.2);
      }
    }
    
    /* Floating animation for the "Text Us" label */
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
    }
    
    .law-chat-bubble:hover {
      transform: scale(1.1);
    }
    
    .law-chat-bubble-icon {
      color: white;
      font-size: 24px;
    }
    
    /* Chat Window */
    .law-chat-window {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 380px;
      height: 580px;
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15), 0 0 1px rgba(0,0,0,0.3);
      overflow: hidden;
      display: none;
      flex-direction: column;
      z-index: 9998;
      transition: all 0.3s ease;
      border: none;
    }
    
    /* Chat Header */
    .law-chat-header {
      background: linear-gradient(135deg, #1a365d 0%, #0d2b4e 100%);
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .law-chat-title {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      letter-spacing: 0.5px;
    }
    
    .law-chat-title-icon {
      margin-right: 12px;
      font-size: 20px;
    }
    
    .law-chat-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      font-size: 18px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0.9;
      transition: all 0.2s ease;
    }
    
    .law-chat-close:hover {
      opacity: 1;
      background: rgba(255,255,255,0.2);
      transform: rotate(90deg);
    }
    
    /* Chat Messages Area */
    .law-chat-messages {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      background-color: #f8f9fa;
      scroll-behavior: smooth;
    }
    
    .law-chat-messages::-webkit-scrollbar {
      width: 6px;
    }
    
    .law-chat-messages::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    .law-chat-messages::-webkit-scrollbar-thumb {
      background: #c5cfd9;
      border-radius: 3px;
    }
    
    /* Video as part of a message */
    .law-chat-video {
      width: 100%;
      height: auto;
      max-width: 100%;
      border-radius: 8px;
      margin-top: 8px;
      margin-bottom: 8px;
    }
    
    /* Message Bubbles */
    .law-chat-message {
      margin-bottom: 14px;
      max-width: 85%;
      display: flex;
      flex-direction: column;
    }
    
    .law-chat-message-user {
      align-self: flex-end;
    }
    
    .law-chat-message-bot {
      align-self: flex-start;
    }
    
    .law-chat-bubble-content {
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.5;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .law-chat-message-user .law-chat-bubble-content {
      background-color: #dbe9ff;
      color: #1a365d;
      border-bottom-right-radius: 4px;
    }
    
    .law-chat-message-bot .law-chat-bubble-content {
      background-color: white;
      color: #333;
      border: 1px solid #e1e5e9;
      border-bottom-left-radius: 4px;
    }
    
    /* Option Bubbles */
    .law-chat-options {
      display: flex;
      flex-wrap: wrap;
      margin-top: 10px;
      gap: 8px;
    }
    
    .law-chat-option {
      background-color: #f0f4f8;
      border: 1px solid #c5cfd9;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      color: #1a365d;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .law-chat-option:hover {
      background-color: #e4ecf7;
      border-color: #1a365d;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .law-chat-option:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .law-chat-time {
      font-size: 11px;
      color: #9aa5b1;
      margin-top: 4px;
      margin-left: 6px;
      margin-right: 6px;
    }
    
    /* Typing Indicator */
    .law-chat-typing {
      display: none;
      margin: 10px 0 14px 20px; /* Added left margin to align with other messages */
    }
    
    .law-chat-typing-dots {
      display: flex;
      align-items: center;
    }
    
    .law-chat-dot {
      width: 8px;
      height: 8px;
      background-color: #9aa5b1;
      border-radius: 50%;
      margin: 0 4px;
      animation: law-chat-typing 1.4s infinite ease-in-out;
    }
    
    .law-chat-dot:nth-child(1) { animation-delay: 0s; }
    .law-chat-dot:nth-child(2) { animation-delay: 0.2s; }
    .law-chat-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes law-chat-typing {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    
    /* Phone Collection Form */
    .law-chat-phone-form {
      margin-top: 12px;
      width: 100%;
    }
    
    .law-chat-phone-input-container {
      display: flex;
      align-items: center;
      background-color: #f7f9fc;
      border-radius: 12px;
      padding: 8px 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 8px;
    }
    
    .law-chat-phone-prefix,
    .law-chat-phone-separator {
      color: #4a5568;
      font-size: 16px;
      font-weight: 500;
    }
    
    .law-chat-phone-input {
      border: none;
      background: transparent;
      font-size: 16px;
      padding: 4px;
      text-align: center;
      width: auto;
      outline: none;
      color: #1a365d;
      font-weight: 500;
    }
    
    .law-chat-phone-input.area-code {
      width: 40px;
    }
    
    .law-chat-phone-input.prefix {
      width: 40px;
    }
    
    .law-chat-phone-input.line {
      width: 50px;
    }
    
    .law-chat-phone-input:focus {
      background-color: rgba(26, 54, 93, 0.05);
      border-radius: 4px;
    }
    
    .law-chat-phone-submit {
      margin-left: auto;
      background-color: #1a365d;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .law-chat-phone-submit:hover:not(:disabled) {
      background-color: #12293f;
      transform: translateY(-1px);
    }
    
    .law-chat-phone-submit:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .law-chat-phone-submit:disabled {
      background-color: #cbd5e0;
      cursor: not-allowed;
    }
    
    .law-chat-phone-privacy {
      font-size: 11px;
      color: #718096;
      text-align: center;
    }
    
    /* Input Area */
    .law-chat-input-container {
      padding: 15px;
      background-color: white;
      border-top: 1px solid #e1e5e9;
      display: flex;
      align-items: center;
    }
    
    .law-chat-input {
      flex-grow: 1;
      padding: 12px 16px;
      border: 1px solid #dfe3e8;
      border-radius: 24px;
      font-size: 15px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      resize: none;
      overflow: hidden;
      height: 24px; /* Exact height for a single line of text */
      max-height: 120px;
      line-height: 24px; /* Match height for single line text */
    }
    
    .law-chat-input:focus {
      border-color: #1a365d;
      box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.15);
    }
    
    .law-chat-send {
      margin-left: 10px;
      width: 44px;
      height: 44px;
      background-color: #1a365d;
      color: white;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(26, 54, 93, 0.2);
    }
    
    .law-chat-send:hover {
      background-color: #10243d;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(26, 54, 93, 0.3);
    }
    
    .law-chat-send:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(26, 54, 93, 0.2);
    }
    
    .law-chat-send:disabled {
      background-color: #e1e5e9;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .law-chat-send-icon {
      font-size: 18px;
    }

    /* Enhanced send button for when recommendations might be available */
    .law-chat-send-with-recommendations {
      background-color: #0f4c81; /* Slightly different color */
      box-shadow: 0 2px 8px rgba(26, 54, 93, 0.4);
    }

    .law-chat-send-with-recommendations:after {
      content: '';
      position: absolute;
      top: -3px;
      right: -3px;
      width: 8px;
      height: 8px;
      background-color: #4299e1;
      border-radius: 50%;
    }

    /* Recommendations Container */
    .law-chat-recommendations {
      margin-top: 10px;
      padding: 12px;
      background-color: #f0f7ff;
      border-radius: 8px;
      border-left: 3px solid #1a365d;
    }

    .law-chat-recommendations h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: #1a365d;
    }

    .law-chat-recommendation-item {
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(26, 54, 93, 0.1);
    }

    .law-chat-recommendation-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .law-chat-recommendation-title {
      display: block;
      font-weight: 500;
      color: #1a365d;
      margin-bottom: 4px;
      text-decoration: none;
    }

    .law-chat-recommendation-title:hover {
      text-decoration: underline;
    }

    .law-chat-recommendation-snippet {
      font-size: 12px;
      color: #4a5568;
      margin: 0;
    }
    
    /* Play Button Overlay */
    .law-chat-video-play {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 8px;
    }
    
    .law-chat-video-play-button {
      width: 50px;
      height: 50px;
      background-color: rgba(255,255,255,0.8);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    /* Mobile Responsive */
    @media (max-width: 480px) {
      .law-chat-window {
        width: 90%;
        height: 80%;
        bottom: 80px;
        right: 5%;
        left: 5%;
      }
    }
  `;
  document.head.appendChild(style);
  
  // Create chat elements
  const chatContainer = document.createElement('div');
  chatContainer.className = 'law-chat-widget';
  
  // Chat bubble
  const chatBubble = document.createElement('div');
  chatBubble.className = 'law-chat-bubble';
  chatBubble.innerHTML = '<div class="law-chat-bubble-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 13.5997 2.37562 15.1116 3.04346 16.4525C3.22094 16.8088 3.28001 17.2161 3.17712 17.6006L2.58151 19.8267C2.32295 20.793 3.20701 21.677 4.17335 21.4185L6.39939 20.8229C6.78393 20.72 7.19121 20.7791 7.54753 20.9565C8.88837 21.6244 10.4003 22 12 22Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 10.5H16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 14H13.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>';

  // Add the notification badge
  const notificationBadge = document.createElement('div');
  notificationBadge.className = 'law-chat-notification';
  notificationBadge.textContent = '1';
  notificationBadge.style.display = 'none'; // Initially hidden
  chatBubble.appendChild(notificationBadge);
  
  // Chat window
  const chatWindow = document.createElement('div');
  chatWindow.className = 'law-chat-window';
  
  // Chat header
  const chatHeader = document.createElement('div');
  chatHeader.className = 'law-chat-header';
  chatHeader.innerHTML = `
    <h3 class="law-chat-title">
      <span class="law-chat-title-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 1.5L1.5 6.5L12 11.5L22.5 6.5L12 1.5Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M1.5 17.5L12 22.5L22.5 17.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M1.5 12L12 17L22.5 12" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg></span>
      Roth Davies Assistant
    </h3>
    <button class="law-chat-close">×</button>
  `;
  
  // Chat messages container
  const messagesContainer = document.createElement('div');
  messagesContainer.className = 'law-chat-messages';
  
  // Typing indicator
  const typingIndicator = document.createElement('div');
  typingIndicator.className = 'law-chat-typing';
  typingIndicator.innerHTML = `
    <div class="law-chat-typing-dots">
      <div class="law-chat-dot"></div>
      <div class="law-chat-dot"></div>
      <div class="law-chat-dot"></div>
    </div>
  `;
  
  // Input container
  const inputContainer = document.createElement('div');
  inputContainer.className = 'law-chat-input-container';
  inputContainer.innerHTML = `
    <textarea class="law-chat-input" placeholder="Type your question here..." rows="1"></textarea>
    <button class="law-chat-send" disabled>
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  `;
  
  // Assemble chat window
  chatWindow.appendChild(chatHeader);
  chatWindow.appendChild(messagesContainer);
  chatWindow.appendChild(typingIndicator);
  chatWindow.appendChild(inputContainer);
  
  // Append elements to container and then to body
  chatContainer.appendChild(chatBubble);
  chatContainer.appendChild(chatWindow);
  document.body.appendChild(chatContainer);
  
  // Get DOM elements
  const inputField = document.querySelector('.law-chat-input');
  const sendButton = document.querySelector('.law-chat-send');
  const closeButton = document.querySelector('.law-chat-close');
  
  // File input method for video loading
  function createFileInput() {
    // Create a hidden file input element
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.id = 'law-chat-video-selector';
    fileInput.accept = 'video/*';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
    
    return fileInput;
  }
  
  // Video sources based on page path keywords
  const videoMap = {
    'default': 'welcome.mp4',
    'personal-injury': 'personal-injury.mp4',
    'criminal-defense': 'criminal-defense.mp4',
    'divorce': 'family-law.mp4'
  };
  
  // Create the file input for fallback method
  const videoFileInput = createFileInput();
  
  // Set video source based on current page
  // Get video filename based on current page
  function getVideoFilename() {
    const currentPath = window.location.pathname.toLowerCase();
    let videoFilename = videoMap.default;
    
    if (currentPath.includes('personal-injury')) {
      videoFilename = videoMap['personal-injury'];
    } else if (currentPath.includes('criminal') || currentPath.includes('defense')) {
      videoFilename = videoMap['criminal-defense'];
    } else if (currentPath.includes('divorce') || currentPath.includes('family')) {
      videoFilename = videoMap['divorce'];
    }
    
    return videoFilename;
  }
  
  // Set video source using direct URL method first, with fallback to file input if needed
  function createVideoMessage() {
    const videoFilename = getVideoFilename();
    
    // Create the video message container
    const videoMessage = document.createElement('div');
    videoMessage.className = 'law-chat-message law-chat-message-bot';
    
    // Create the message content container
    const messageContent = document.createElement('div');
    messageContent.className = 'law-chat-bubble-content';
    
    // Create the video element
    const videoElement = document.createElement('video');
    videoElement.className = 'law-chat-video';
    videoElement.controls = true;
    videoElement.autoplay = true;
    videoElement.muted = false; // Allow sound
    videoElement.playsInline = true; // For iOS
    
    // First try with a relative path
    const videoSrc = `videos/${videoFilename}`;
    videoElement.src = videoSrc;
    
    // Add error handling for video loading
    videoElement.onerror = function() {
      console.log("Error loading video with direct path, trying alternate methods...");
      
      // Try with a file URL as fallback (only works on some browsers)
      if (window.location.protocol === 'file:') {
        // For local file testing
        const videoPath = `${window.location.href.substring(0, window.location.href.lastIndexOf('/'))}`;
        const fullPath = `${videoPath}/videos/${videoFilename}`;
        console.log("Trying with file URL:", fullPath);
        videoElement.src = fullPath;
        
        videoElement.onerror = function() {
          // Last resort - show file input on error
          handleVideoLoadError(messageContent, videoElement);
        };
      } else {
        // Last resort - show file input on error
        handleVideoLoadError(messageContent, videoElement);
      }
    };
    
    
    // Assemble the message
    messageContent.appendChild(videoElement);
    videoMessage.appendChild(messageContent);
    
    // Add time stamp
    const timeStamp = document.createElement('div');
    timeStamp.className = 'law-chat-time';
    timeStamp.textContent = formatTime();
    videoMessage.appendChild(timeStamp);
    
    return videoMessage;
  }

  // Notification Functions
  function showNotification() {
    const notificationBadge = document.querySelector('.law-chat-notification');
    if (notificationBadge) {
      notificationBadge.style.display = 'flex';
    }
  }

  function hideNotification() {
    const notificationBadge = document.querySelector('.law-chat-notification');
    if (notificationBadge) {
      notificationBadge.style.display = 'none';
    }
  }
  
  // Handle video load error with file input fallback
  function handleVideoLoadError(container, videoElement) {
    // If we're here, normal loading methods failed
    console.log("Falling back to manual file selection");
    
    // Remove the video element temporarily
    if (videoElement.parentNode === container) {
      container.removeChild(videoElement);
    }
    
    // Display a message and button to select video
    const errorMessage = document.createElement('div');
    errorMessage.innerHTML = `
      <p style="margin-bottom: 10px;">Unable to load the introduction video automatically.</p>
      <button id="select-video-btn" style="padding: 8px 16px; background: #c41230; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Select Video Manually
      </button>
    `;
    container.appendChild(errorMessage);
    
    // Add click event to the button
    setTimeout(() => {
      document.getElementById('select-video-btn').addEventListener('click', function() {
        videoFileInput.click();
      });
      
      // Handle file selection
      videoFileInput.onchange = function() {
        if (this.files && this.files[0]) {
          const objectURL = URL.createObjectURL(this.files[0]);
          
          // Remove the error message
          container.removeChild(errorMessage);
          
          // Reset the video element
          videoElement.src = objectURL;
          container.appendChild(videoElement);
          
          videoElement.load();
          videoElement.play().catch(e => console.log("Autoplay prevented:", e));
        }
      };
    }, 0);
  }
  
  // OpenAI API Key - This should be replaced with a secure backend in production
  // IMPORTANT: Exposing API keys in frontend code is not secure for production
  // This is only for demo purposes
  const OPENAI_API_KEY = "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";
  // Pinecone configuration
  const PINECONE_API_KEY = "pcsk_7go2e_KA1R7n698TVxy8hvzW8N6vWFB3miVDRGufrEb8BSbkkEDxWV7FftmuZZbaP4WWs"; // Replace with your actual API key
  const PINECONE_INDEX = "roth-davies-legal"; // Your index name
  const PINECONE_ENVIRONMENT = "us-east-1-aws"; // e.g., "us-east-1-aws"
  const PINECONE_PROJECT_ID = "c4893398-fa1a-4533-8cdb-19634aeeb670"; // From your Pinecone dashboard
  
  // Chat flow variables
  let chatHistory = [];
  let qualificationStage = 'initial'; // Possible values: initial, caseType, location, qualified
  let userCaseType = null;
  let userLocation = null;
  let videoAdded = false;
  
  // Utility functions
  function formatTime() {
    const now = new Date();
    return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  // Add these utility functions for random delays
  function getRandomDelay(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  // Function to calculate typing delay based on message length
  function calculateTypingDelay(message, minDelay = 2000, maxDelay = 5000, apiLatency = 0) {
    // Base time is proportional to message length (longer messages take more time)
    const charCount = message.length;
    const baseDelay = Math.min(maxDelay, Math.max(minDelay, charCount * 15));
    
    // Subtract API latency time but ensure we still have a minimum delay
    const adjustedDelay = Math.max(minDelay / 2, baseDelay - apiLatency);
    
    // Add some randomness (±15%)
    const randomFactor = 1 + ((Math.random() * 0.3) - 0.15);
    return Math.round(adjustedDelay * randomFactor);
  }

  // Modify your addMessage function to include delays
// Make sure the addMessage function also hides the typing indicator
function addMessage(content, isUser, options = null) {
  // If it's a user message, add it immediately
  if (isUser) {
    const messageClass = 'law-chat-message-user';
    const messageTime = formatTime();
    
    const messageElement = document.createElement('div');
    messageElement.className = `law-chat-message ${messageClass}`;
    
    let messageContent = `<div class="law-chat-bubble-content">${content}</div>`;
    messageContent += `<div class="law-chat-time">${messageTime}</div>`;
    messageElement.innerHTML = messageContent;
    
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Update chat history
    chatHistory.push({
      role: "user",
      content: content
    });
    return;
  }
  
  // For bot messages, show typing indicator and delay
  showTypingIndicator();
  
  // Calculate delay - simple options vs LLM response
  let delay;
  if (options) {
    // For pre-configured messages (qualification flow)
    delay = getRandomDelay(1500, 2500);
  } else {
    // For LLM responses, use more sophisticated calculation
    // apiLatency would be measured during the API call
    // For demo purposes, we'll assume a random API latency
    const simulatedApiLatency = apiLatency || 0;
    delay = calculateTypingDelay(content, 2000, 5000, simulatedApiLatency);
  }
  
  // Create timer for delay
  setTimeout(() => {
    hideTypingIndicator(); // Make sure typing indicator is hidden
    
    const messageClass = 'law-chat-message-bot';
    const messageTime = formatTime();
    
    const messageElement = document.createElement('div');
    messageElement.className = `law-chat-message ${messageClass}`;
    
    let messageContent = `<div class="law-chat-bubble-content">${content}</div>`;
    
    // Add options if provided
    if (options) {
      messageContent += `
        <div class="law-chat-options">
          ${options.map(option => `<div class="law-chat-option" data-value="${option.value}">${option.text}</div>`).join('')}
        </div>
      `;
    }
    
    messageContent += `<div class="law-chat-time">${messageTime}</div>`;
    messageElement.innerHTML = messageContent;
    
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Add click event listeners to options
    if (options) {
      const optionElements = messageElement.querySelectorAll('.law-chat-option');
      optionElements.forEach(optionElement => {
        optionElement.addEventListener('click', function() {
          const selectedValue = this.getAttribute('data-value');
          const selectedText = this.textContent;
          handleOptionSelection(selectedValue, selectedText);
        });
      });
    }
    
    // Update chat history for non-option messages
    if (!options) {
      chatHistory.push({
        role: "assistant",
        content: content
      });
    }
  }, delay);
}
  
  function handleOptionSelection(value, text) {
    // Add the selected option as a user message
    addMessage(text, true);
    
    // Handle the qualification flow
    if (qualificationStage === 'initial') {
      userCaseType = value;
      qualificationStage = 'caseType';
      
      // Ask for location with buttons
      const isKanasOrMissouri = [
        { value: 'kansas', text: 'Kansas' },
        { value: 'missouri', text: 'Missouri' },
        { value: 'other', text: 'Other State' }
      ];
      addMessage("Thank you. Is your case in Kansas or Missouri?", false, isKanasOrMissouri);
      
    } else if (qualificationStage === 'caseType') {
      userLocation = value;
      qualificationStage = 'location';
      
      if (value === 'kansas' || value === 'missouri') {
        // Qualified - proceed with phone collection
        qualificationStage = 'phone-collection';
        
        // Create a phone number collection message
        const phoneMessage = document.createElement('div');
        phoneMessage.className = 'law-chat-message law-chat-message-bot';
        
        // Create phone collection form
        const phoneContent = document.createElement('div');
        phoneContent.className = 'law-chat-bubble-content';
        phoneContent.innerHTML = `
          <p>Great! I'd be happy to discuss your ${userCaseType} case in ${text}.</p>
          <p>To connect you with the right attorney, could you provide your phone number?</p>
          <div class="law-chat-phone-form">
            <div class="law-chat-phone-input-container">
              <div class="law-chat-phone-prefix">(</div>
              <input type="tel" class="law-chat-phone-input area-code" maxlength="3" placeholder="000">
              <div class="law-chat-phone-separator">)</div>
              <input type="tel" class="law-chat-phone-input prefix" maxlength="3" placeholder="000">
              <div class="law-chat-phone-separator">-</div>
              <input type="tel" class="law-chat-phone-input line" maxlength="4" placeholder="0000">
              <button class="law-chat-phone-submit" disabled>Submit</button>
            </div>
            <div class="law-chat-phone-privacy">Your information is secure and will not be shared with third parties.</div>
          </div>
        `;
        
        // Add timestamp
        const timeStamp = document.createElement('div');
        timeStamp.className = 'law-chat-time';
        timeStamp.textContent = formatTime();
        
        // Assemble the message
        phoneMessage.appendChild(phoneContent);
        phoneMessage.appendChild(timeStamp);
        messagesContainer.appendChild(phoneMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Add event listeners for the phone input fields
        setTimeout(() => {
          const areaCodeInput = document.querySelector('.law-chat-phone-input.area-code');
          const prefixInput = document.querySelector('.law-chat-phone-input.prefix');
          const lineInput = document.querySelector('.law-chat-phone-input.line');
          const submitButton = document.querySelector('.law-chat-phone-submit');
          
          // Auto-focus the first input
          areaCodeInput.focus();
          
          // Function to validate the phone number
          const validatePhone = () => {
            const areaCode = areaCodeInput.value;
            const prefix = prefixInput.value;
            const line = lineInput.value;
            
            // Enable/disable submit button based on form completeness
            submitButton.disabled = !(
              areaCode.length === 3 && 
              prefix.length === 3 && 
              line.length === 4 &&
              /^[0-9]+$/.test(areaCode) &&
              /^[0-9]+$/.test(prefix) &&
              /^[0-9]+$/.test(line)
            );
          };
          
          // Add input listeners to each field
          [areaCodeInput, prefixInput, lineInput].forEach(input => {
            // Allow only numbers
            input.addEventListener('input', (e) => {
              e.target.value = e.target.value.replace(/[^0-9]/g, '');
              validatePhone();
              
              // Auto-advance to next field if current is full
              if (e.target.value.length === parseInt(e.target.getAttribute('maxlength'))) {
                if (e.target === areaCodeInput) prefixInput.focus();
                if (e.target === prefixInput) lineInput.focus();
              }
            });
            
            // Handle backspace to go to previous field
            input.addEventListener('keydown', (e) => {
              if (e.key === 'Backspace' && e.target.value.length === 0) {
                if (e.target === lineInput) prefixInput.focus();
                if (e.target === prefixInput) areaCodeInput.focus();
              }
            });
          });
          
          // Handle form submission
          submitButton.addEventListener('click', () => {
            const phoneNumber = `(${areaCodeInput.value}) ${prefixInput.value}-${lineInput.value}`;
            
            // Send the phone number to the server
            submitPhoneNumber(phoneNumber);
            
            // Add the phone number as a user message
            addMessage(`My phone number is ${phoneNumber}`, true);
            
            // Update the chat stage
            qualificationStage = 'qualified';
            
            // Show thank you message
            addMessage("Thank you for for that. Could you tell me a little bit about your case?", false);
          });
        }, 100);
      } else {
        // Not qualified - provide alternate contact
        addMessage("I'm sorry, but our firm only handles cases in Kansas and Missouri. Would you like to speak with one of our attorneys anyway to see if we can refer you to someone in your area?", false, [
          { value: 'yes-referral', text: 'Yes, I\'d like a referral' },
          { value: 'no-thanks', text: 'No, thank you' }
        ]);
      }
    } else if (qualificationStage === 'location' && (value === 'yes-referral' || value === 'no-thanks')) {
      if (value === 'yes-referral') {
        // Ask for phone number for referral
        qualificationStage = 'phone-collection';
        
        // Create a phone number collection message for referral
        const phoneMessage = document.createElement('div');
        phoneMessage.className = 'law-chat-message law-chat-message-bot';
        
        // Create phone collection form
        const phoneContent = document.createElement('div');
        phoneContent.className = 'law-chat-bubble-content';
        phoneContent.innerHTML = `
          <p>We'd be happy to refer you to an attorney in your area.</p>
          <p>Please provide your phone number so we can contact you:</p>
          <div class="law-chat-phone-form">
            <div class="law-chat-phone-input-container">
              <div class="law-chat-phone-prefix">(</div>
              <input type="tel" class="law-chat-phone-input area-code" maxlength="3" placeholder="000">
              <div class="law-chat-phone-separator">)</div>
              <input type="tel" class="law-chat-phone-input prefix" maxlength="3" placeholder="000">
              <div class="law-chat-phone-separator">-</div>
              <input type="tel" class="law-chat-phone-input line" maxlength="4" placeholder="0000">
              <button class="law-chat-phone-submit" disabled>Submit</button>
            </div>
            <div class="law-chat-phone-privacy">Your information is secure and will not be shared with third parties.</div>
          </div>
        `;
        
        // Add timestamp
        const timeStamp = document.createElement('div');
        timeStamp.className = 'law-chat-time';
        timeStamp.textContent = formatTime();
        
        // Assemble the message
        phoneMessage.appendChild(phoneContent);
        phoneMessage.appendChild(timeStamp);
        messagesContainer.appendChild(phoneMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Add event listeners with the same phone input functionality
        setTimeout(() => {
          const areaCodeInput = document.querySelector('.law-chat-phone-input.area-code');
          const prefixInput = document.querySelector('.law-chat-phone-input.prefix');
          const lineInput = document.querySelector('.law-chat-phone-input.line');
          const submitButton = document.querySelector('.law-chat-phone-submit');
          
          // Auto-focus the first input
          areaCodeInput.focus();
          
          // Function to validate the phone number
          const validatePhone = () => {
            const areaCode = areaCodeInput.value;
            const prefix = prefixInput.value;
            const line = lineInput.value;
            
            // Enable/disable submit button based on form completeness
            submitButton.disabled = !(
              areaCode.length === 3 && 
              prefix.length === 3 && 
              line.length === 4 &&
              /^[0-9]+$/.test(areaCode) &&
              /^[0-9]+$/.test(prefix) &&
              /^[0-9]+$/.test(line)
            );
          };
          
          // Add input listeners to each field
          [areaCodeInput, prefixInput, lineInput].forEach(input => {
            // Allow only numbers
            input.addEventListener('input', (e) => {
              e.target.value = e.target.value.replace(/[^0-9]/g, '');
              validatePhone();
              
              // Auto-advance to next field if current is full
              if (e.target.value.length === parseInt(e.target.getAttribute('maxlength'))) {
                if (e.target === areaCodeInput) prefixInput.focus();
                if (e.target === prefixInput) lineInput.focus();
              }
            });
            
            // Handle backspace to go to previous field
            input.addEventListener('keydown', (e) => {
              if (e.key === 'Backspace' && e.target.value.length === 0) {
                if (e.target === lineInput) prefixInput.focus();
                if (e.target === prefixInput) areaCodeInput.focus();
              }
            });
          });
          
          // Handle form submission
          submitButton.addEventListener('click', () => {
            const phoneNumber = `(${areaCodeInput.value}) ${prefixInput.value}-${lineInput.value}`;
            
            // Send the phone number to the server
            submitPhoneNumber(phoneNumber, true); // true indicates this is a referral
            
            // Add the phone number as a user message
            addMessage(`My phone number is ${phoneNumber}`, true);
            
            // Update the chat stage
            qualificationStage = 'qualified';
            
            // Show thank you message
            addMessage("Thank you! We'll have an attorney contact you soon about a referral to a lawyer in your area. Is there anything else I can help with in the meantime?", false);
          });
        }, 100);
      } else {
        addMessage("I understand. If you have any other questions or change your mind, please feel free to ask. Is there anything else I can help with?", false);
        // Set as qualified so they can continue chatting if they want
        qualificationStage = 'qualified';
      }
    }
  }
  
  function showTypingIndicator() {
    typingIndicator.style.display = 'flex';
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
  
  function hideTypingIndicator() {
    typingIndicator.style.display = 'none';
  }

  // variable to track API latency
  let apiLatency = 0;
  
  async function sendMessageToOpenAI(message) {
  showTypingIndicator();
  
  // Record start time to measure API latency
  const startTime = Date.now();
  
  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        messages: [
          {
            role: "system",
            content: `You are a helpful, friendly assistant for a law firm in Overland Park, Kansas. 
            Your primary job is to provide information about ${userCaseType} cases, the law firm's services, and 
            general guidance. Remember that you cannot provide specific legal advice. Always encourage potential 
            clients to schedule a free consultation for specific case evaluations. The firm specializes in car accidents, 
            truck accidents, slip and fall injuries, workplace injuries, medical malpractice, and wrongful death claims 
            in the area of personal injury, as well as criminal defense and divorce/family law. 
            They work on a contingency fee basis for personal injury cases - no fee unless they win the case. Free consultations are available 
            by calling (913) 451-9500. The client has indicated they have a ${userCaseType} case in ${userLocation}.`
          },
          ...chatHistory
        ],
        temperature: 0.7,
        max_tokens: 500
      })
    });
    
    // Calculate API latency
    apiLatency = Date.now() - startTime;
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    const aiResponse = data.choices[0].message.content;
    
    // Check if recommendations are needed before adding the AI response
    let recommendations = [];
    if (qualificationStage === 'qualified') {
      // Only query for recommendations after user is qualified and for certain topics
      const shouldRecommendContent = userCaseType && 
        (message.length > 10) && // Only for substantive messages
        !message.toLowerCase().includes("hello") && // Skip greetings
        !message.toLowerCase().includes("thank"); // Skip thank you messages

      if (shouldRecommendContent) {
        try {
          // Context-aware search query that includes user's case type
          const searchQuery = `${userCaseType} ${message}`; 
          recommendations = await queryPineconeForRelevantContent(searchQuery);
        } catch (error) {
          console.error("Error fetching recommendations:", error);
          recommendations = [];
        }
      }
    }
    
    // Make sure typing indicator is hidden
    hideTypingIndicator();
    
    // Create a complete response that includes both AI response and recommendations
    if (recommendations && recommendations.length > 0) {
      // Add the message with recommendations
      addMessageWithRecommendations(aiResponse, recommendations);
    } else {
      // Just add the AI response without recommendations
      addMessage(aiResponse, false);
    }
    
  } catch (error) {
    console.error("Error calling OpenAI API:", error);
    apiLatency = Date.now() - startTime; // Still record latency even for errors
    hideTypingIndicator(); // Make sure typing indicator is hidden on error
    addMessage("I'm sorry, I'm having trouble connecting right now. Please try again or call our office directly at (913) 451-9500.", false);
  }
}

// Update the addMessageWithRecommendations function to hide the typing indicator
function addMessageWithRecommendations(content, recommendations) {
  // Hide typing indicator first
  hideTypingIndicator();
  
  // Create the message element
  const messageElement = document.createElement('div');
  messageElement.className = 'law-chat-message law-chat-message-bot';
  
  // Create the message content
  const messageContent = document.createElement('div');
  messageContent.className = 'law-chat-bubble-content';
  messageContent.innerHTML = content;
  
  // Create the recommendations container
  const recommendationsDiv = document.createElement('div');
  recommendationsDiv.className = 'law-chat-recommendations';
  
  // Add heading
  const heading = document.createElement('h4');
  heading.textContent = 'You might find these resources helpful:';
  recommendationsDiv.appendChild(heading);
  
  // Add each recommendation
  recommendations.forEach(rec => {
    const item = document.createElement('div');
    item.className = 'law-chat-recommendation-item';
    
    const title = document.createElement('a');
    title.className = 'law-chat-recommendation-title';
    title.href = rec.url || '#';
    title.textContent = rec.title || 'Resource';
    title.target = '_blank';
    
    const snippet = document.createElement('p');
    snippet.className = 'law-chat-recommendation-snippet';
    snippet.textContent = rec.snippet || 'Related information about your case.';
    
    item.appendChild(title);
    item.appendChild(snippet);
    recommendationsDiv.appendChild(item);
  });
  
  // Add the recommendations before the message content
  messageElement.appendChild(recommendationsDiv);
  messageElement.appendChild(messageContent);
  
  // Add timestamp
  const timeStamp = document.createElement('div');
  timeStamp.className = 'law-chat-time';
  timeStamp.textContent = formatTime();
  messageElement.appendChild(timeStamp);
  
  // Append the message to the chat
  messagesContainer.appendChild(messageElement);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  // Update chat history
  chatHistory.push({
    role: "assistant",
    content: content
  });
}
// Fix 2: Fix the submitPhoneNumber function to enable the send button after phone submission
function submitPhoneNumber(phoneNumber, isReferral = false) {
    console.log(`Submitting phone number: ${phoneNumber}, Referral: ${isReferral}`);
    
    // Format the data for the Twilio API
    let caseTypeText = userCaseType;
    if (caseTypeText === 'personal-injury') caseTypeText = 'Personal Injury';
    if (caseTypeText === 'criminal-defense') caseTypeText = 'Criminal Defense';
    if (caseTypeText === 'divorce') caseTypeText = 'Divorce';
    
    let locationText = userLocation;
    if (locationText === 'kansas') locationText = 'Kansas';
    if (locationText === 'missouri') locationText = 'Missouri';
    if (locationText === 'other') locationText = 'Other State';
    
    // Create the message body
    const messageBody = `Roth Davies Chatbot - New Incoming Lead: ${caseTypeText} case in ${locationText}. Phone: ${phoneNumber}`;
    
    // Send SMS via Twilio API
    fetch('https://api.twilio.com/2010-04-01/Accounts/ACb792a1845ad1566a1269c58dcaeb3eca/Messages.json', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': 'Basic ' + btoa('ACb792a1845ad1566a1269c58dcaeb3eca:dd8629fe9c5202915173a2fa7cf0462c') // Replace with actual auth token
      },
      body: new URLSearchParams({
        'To': '+19136020456',
        'From': '+19133956075',
        'Body': messageBody
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Twilio SMS sent successfully:', data);
    })
    .catch(error => {
      console.error('Error sending Twilio SMS:', error);
      // Still continue with the chatbot flow even if the SMS fails
    });

    // FIX: Explicitly enable the send button after phone submission
    setTimeout(() => {
      const sendButton = document.querySelector('.law-chat-send');
      if (sendButton) {
        sendButton.disabled = false;
      }
    }, 500);
}

// Fix 3: Add listener to enable send button when input field has text
// This should be placed after your other event listeners
inputField.addEventListener('input', () => {
  sendButton.disabled = inputField.value.trim() === '';
});

// Fix 4: Update the input field enter key handling to be more robust
inputField.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    const message = inputField.value.trim();
    if (message && qualificationStage === 'qualified') {
      sendButton.click();
    }
  }
});

    // Function to query Pinecone for relevant content based on user's message
    async function queryPineconeForRelevantContent(userMessage) {
  try {
    console.log("Starting Pinecone query for:", userMessage);
    
    // First, get an embedding for the user's query
    const embeddingResponse = await fetch('https://api.openai.com/v1/embeddings', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        input: userMessage,
        model: "text-embedding-ada-002" // OpenAI's embedding model
      })
    });
    
    if (!embeddingResponse.ok) {
      console.error(`Error getting embedding: ${embeddingResponse.status}`);
      return [];
    }
    
    const embeddingData = await embeddingResponse.json();
    const fullEmbedding = embeddingData.data[0].embedding;
    console.log("Original embedding length:", fullEmbedding.length);
    
    // Reduce dimension from 1536 to 768 using Principal Component Projection
    // This approach preserves more information than simple truncation
    const reducedEmbedding = reduceEmbeddingDimension(fullEmbedding, 768);
    console.log("Reduced embedding length:", reducedEmbedding.length);
    
    // Use the correct Pinecone URL format with Host ID
    const pineconeUrl = `https://${PINECONE_INDEX}-4w5mo1c.svc.aped-4627-b74a.pinecone.io/query`;
    
    // Build the request body with reduced embedding
    const requestBody = {
      vector: reducedEmbedding,
      topK: 3,
      includeMetadata: true
    };
    
    // Log the first 5 values to confirm it looks right
    console.log("Vector sample (first 5 values):", requestBody.vector.slice(0, 5));
    console.log("Vector length:", requestBody.vector.length);
    
    // Make the request to Pinecone
    const pineconeResponse = await fetch(pineconeUrl, {
      method: 'POST',
      headers: {
        'Api-Key': PINECONE_API_KEY,
        'Content-Type': 'application/json',
        'X-Pinecone-API-Version': '2025-01'
      },
      body: JSON.stringify(requestBody)
    });
    
    // Log response status
    console.log("Pinecone response status:", pineconeResponse.status);
    
    if (!pineconeResponse.ok) {
      console.error(`Pinecone query failed: ${pineconeResponse.status}`);
      try {
        const errorText = await pineconeResponse.text();
        console.error("Error response:", errorText);
      } catch (e) {
        console.error("Could not read error response");
      }
      return [];
    }
    
    const results = await pineconeResponse.json();
    console.log("Pinecone response:", results);
    
    // Return formatted results if there are matches
    if (results.matches && results.matches.length > 0) {
      return results.matches.map(match => ({
        title: match.metadata.title || "Related Resource",
        url: match.metadata.url || "#",
        snippet: match.metadata.snippet || "Information related to your case",
        category: match.metadata.category || "Legal",
        score: match.score
      }));
    } else {
      console.log("No matches found in Pinecone response");
      return [];
    }
  } catch (error) {
    console.error('Error querying Pinecone:', error);
    return []; // Return empty array in case of error
  }
}

function reduceEmbeddingDimension(embedding, targetDimension) {
  if (embedding.length <= targetDimension) {
    return embedding; // No reduction needed
  }
  
  // Method 1: Adaptive Pooling - combines pairs of adjacent dimensions
  // This preserves more semantic information than simple truncation
  if (embedding.length === targetDimension * 2) {
    // For 1536 → 768, we can combine adjacent pairs
    const reduced = [];
    for (let i = 0; i < embedding.length; i += 2) {
      // Weighted average of adjacent dimensions
      const combined = (embedding[i] * 0.6 + embedding[i + 1] * 0.4);
      reduced.push(combined);
    }
    return reduced;
  }
  
  // Method the 2: Mixed approach for odd ratios
  // Combines PCA-like projection with feature selection
  // First, divide the embedding into two halves
  const firstHalf = embedding.slice(0, Math.ceil(embedding.length / 2));
  const secondHalf = embedding.slice(Math.ceil(embedding.length / 2));
  
  // Take the most significant elements from each half
  const elementsFromEachHalf = Math.ceil(targetDimension / 2);
  
  // Get every Nth element from each half to reach the target dimension
  const strideFirst = Math.floor(firstHalf.length / elementsFromEachHalf);
  const strideSecond = Math.floor(secondHalf.length / elementsFromEachHalf);
  
  const reduced = [];
  
  // Add elements from first half with stride
  for (let i = 0; i < firstHalf.length && reduced.length < elementsFromEachHalf; i += strideFirst) {
    reduced.push(firstHalf[i]);
  }
  
  // Add elements from second half with stride
  for (let i = 0; i < secondHalf.length && reduced.length < targetDimension; i += strideSecond) {
    reduced.push(secondHalf[i]);
  }
  
  // If we still need more elements to reach target dimension, add remaining elements
  // from the beginning of the embedding (these typically contain more information)
  while (reduced.length < targetDimension) {
    const index = reduced.length % embedding.length;
    reduced.push(embedding[index]);
  }
  
  // Normalize the reduced embedding to maintain similar magnitude
  const originalMagnitude = Math.sqrt(embedding.reduce((sum, val) => sum + val * val, 0));
  const reducedMagnitude = Math.sqrt(reduced.reduce((sum, val) => sum + val * val, 0));
  const scaleFactor = originalMagnitude / reducedMagnitude;
  
  return reduced.map(val => val * scaleFactor);
}


// Try additional formats if standard request fails
async function tryAlternativePineconeFormats(userMessage, queryEmbedding) {
  console.log("Trying alternative Pinecone request formats");
  
  // Different parameter variations that might work
  const variations = [
    {
      // Variation 1: Different field names
      body: {
        vector: queryEmbedding,
        top_k: 3,  // Note: underscore instead of camelCase
        include_metadata: true  // Note: underscore instead of camelCase
      }
    },
    {
      // Variation 2: Include namespace field
      body: {
        vector: queryEmbedding,
        topK: 3,
        includeMetadata: true,
        namespace: ""  // Empty namespace
      }
    },
    {
      // Variation 3: Include values field
      body: {
        vector: queryEmbedding,
        topK: 3,
        includeMetadata: true,
        includeValues: false
      }
    }
  ];
  
  const pineconeUrl = `https://${PINECONE_INDEX}-4w5mo1c.svc.aped-4627-b74a.pinecone.io/query`;
  
  // Try each variation
  for (let i = 0; i < variations.length; i++) {
    try {
      console.log(`Trying variation ${i+1}:`, variations[i].body);
      
      const response = await fetch(pineconeUrl, {
        method: 'POST',
        headers: {
          'Api-Key': PINECONE_API_KEY,
          'Content-Type': 'application/json',
          'X-Pinecone-API-Version': '2025-01'
        },
        body: JSON.stringify(variations[i].body)
      });
      
      console.log(`Variation ${i+1} response status:`, response.status);
      
      if (response.ok) {
        const results = await response.json();
        console.log(`Variation ${i+1} succeeded:`, results);
        
        if (results.matches && results.matches.length > 0) {
          return results.matches.map(match => ({
            title: match.metadata.title || "Related Resource",
            url: match.metadata.url || "#",
            snippet: match.metadata.snippet || "Information related to your case",
            category: match.metadata.category || "Legal",
            score: match.score
          }));
        }
      } else {
        try {
          const errorText = await response.text();
          console.error(`Variation ${i+1} error:`, errorText);
        } catch (e) {
          console.error(`Could not read variation ${i+1} error response`);
        }
      }
    } catch (error) {
      console.error(`Error with variation ${i+1}:`, error);
    }
  }
  
  console.log("All variations failed");
  return [];
}

// Store the embedding globally for reuse
window.lastEmbedding = null;

// Function to get embedding separately
async function getEmbedding(text) {
  try {
    const response = await fetch('https://api.openai.com/v1/embeddings', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        input: text,
        model: "text-embedding-ada-002"
      })
    });
    
    if (!response.ok) {
      throw new Error(`Error ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    const embedding = data.data[0].embedding;
    
    // Store for potential reuse
    window.lastEmbedding = embedding;
    
    return embedding;
  } catch (error) {
    console.error("Error getting embedding:", error);
    return null;
  }
}


async function triggerRecommendations(message) {
  if (!message || !userCaseType || qualificationStage !== 'qualified') {
    return;
  }
  
  try {
    // Only trigger for substantive messages
    if (message.length > 10 && 
        !message.toLowerCase().includes("hello") && 
        !message.toLowerCase().includes("thank")) {
      
      // Context-aware search query that includes user's case type
      const searchQuery = `${userCaseType} ${message}`;
      
      const recommendations = await queryPineconeForRelevantContent(searchQuery);
      
      if (recommendations && recommendations.length > 0) {
        // Short delay to make it feel natural
        setTimeout(() => {
          displayContentRecommendations(recommendations);
        }, 1000);
      }
    }
  } catch (error) {
    console.error("Error retrieving recommendations");
  }
}
  
  // Fallback responses for offline demo (if the API key isn't provided)
  const fallbackResponses = {
    "accident": "If you've been in an accident, your health is the first priority. Seek medical attention right away, even if you feel fine - some injuries aren't immediately apparent. Then, document everything you can about the accident and call us at (913) 451-9500 for a free consultation to discuss your legal options.",
    "worth": "Every personal injury case is unique. The value depends on factors like medical expenses, lost wages, pain and suffering, and long-term impacts. We offer a free consultation to evaluate your specific situation and give you a better understanding of what compensation you might expect.",
    "settlement": "Most personal injury cases settle before trial, but we prepare every case as if it will go to court. This approach often leads to better settlement offers. The timeline varies from a few months to over a year depending on case complexity and the extent of your injuries.",
    "fault": "Kansas follows a modified comparative negligence rule, meaning you can still recover damages even if you were partially at fault, as long as your fault is less than 50%. Your compensation may be reduced by your percentage of fault. We can evaluate your situation during a free consultation.",
    "fees": "We work on a contingency fee basis, which means you pay nothing upfront, and we only get paid if we win your case. Our fee is typically a percentage of your settlement or verdict. This arrangement allows anyone to access quality legal representation regardless of their financial situation.",
    "consultation": "We offer a free 30-minute consultation to discuss your case. You can schedule by calling (913) 451-9500. We also offer virtual consultations if that's more convenient for you.",
    "evidence": "Important evidence in personal injury cases includes medical records, accident reports, witness statements, photographs, video footage, and documentation of lost wages. The sooner you contact us, the better we can help preserve crucial evidence for your case.",
    "timeline": "Most personal injury cases resolve within 3-12 months, though complex cases can take longer. We work efficiently to reach a resolution while still pursuing maximum compensation for your injuries."
  };
  
  // Function for using fallback responses if API key isn't available
  function processFallbackResponse(message) {
  showTypingIndicator();
  
  let response = "Thank you for your question. Our team would be happy to provide more specific information during a free consultation. Would you like us to contact you to schedule a time to talk? You can reach us at (913) 451-9500.";
  
  // Check for keywords in the message
  const lowercaseMessage = message.toLowerCase();
  Object.keys(fallbackResponses).forEach(key => {
    if (lowercaseMessage.includes(key)) {
      response = fallbackResponses[key];
    }
  });
  
  // For fallback responses, we use the simple delay (since there's no API latency)
  addMessage(response, false);
}
  
  // Event listeners
  // Add content detection logic - this lets us predict when a query might need recommendations
  inputField.addEventListener('keyup', (e) => {
    // Only process for qualified users and longer messages
    if (qualificationStage === 'qualified' && inputField.value.length > 15) {
      // Look for keywords that suggest a legal question that could benefit from resources
      const legalQuestionIndicators = [
        'how', 'what', 'when', 'why', 'can', 'should', 'is it', 'do i', 
        'accident', 'injury', 'compensation', 'settlement', 'court', 
        'insurance', 'medical', 'police', 'charges', 'rights'
      ];
      
      // Check if the message contains any indicators
      const messageText = inputField.value.toLowerCase();
      const mightNeedResources = legalQuestionIndicators.some(indicator => 
        messageText.includes(indicator)
      );
      
      // If it looks like a message that could benefit from resources, preload the send button
      if (mightNeedResources) {
        // Add a subtle visual indicator that recommendations might be available
        sendButton.classList.add('law-chat-send-with-recommendations');
      } else {
        sendButton.classList.remove('law-chat-send-with-recommendations');
      }
    }
  });
  
  // Function to submit phone number to server
  function submitPhoneNumber(phoneNumber, isReferral = false) {
    console.log(`Submitting phone number: ${phoneNumber}, Referral: ${isReferral}`);
    
    // Format the data for the Twilio API
    let caseTypeText = userCaseType;
    if (caseTypeText === 'personal-injury') caseTypeText = 'Personal Injury';
    if (caseTypeText === 'criminal-defense') caseTypeText = 'Criminal Defense';
    if (caseTypeText === 'divorce') caseTypeText = 'Divorce';
    
    let locationText = userLocation;
    if (locationText === 'kansas') locationText = 'Kansas';
    if (locationText === 'missouri') locationText = 'Missouri';
    if (locationText === 'other') locationText = 'Other State';
    
    // Create the message body
    const messageBody = `Roth Davies Chatbot - New Incoming Lead: ${caseTypeText} case in ${locationText}. Phone: ${phoneNumber}`;
    
    // Send SMS via Twilio API
    fetch('https://api.twilio.com/2010-04-01/Accounts/ACb792a1845ad1566a1269c58dcaeb3eca/Messages.json', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': 'Basic ' + btoa('ACb792a1845ad1566a1269c58dcaeb3eca:dd8629fe9c5202915173a2fa7cf0462c') // Replace with actual auth token
      },
      body: new URLSearchParams({
        'To': '+19136020456',
        'From': '+19133956075',
        'Body': messageBody
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Twilio SMS sent successfully:', data);
    })
    .catch(error => {
      console.error('Error sending Twilio SMS:', error);
      // Still continue with the chatbot flow even if the SMS fails
    });

    // You can still keep any existing lead tracking code here if needed
  }
  
  sendButton.addEventListener('click', () => {
  const message = inputField.value.trim();
  if (message) {
    addMessage(message, true);
    inputField.value = '';
    inputField.style.height = '24px';
    sendButton.disabled = true;
    
    // Only use OpenAI if user is qualified
    if (qualificationStage === 'qualified') {
      // Send to OpenAI - recommendations will be handled inside this function now
      sendMessageToOpenAI(message);
      
      // Remove this duplicate call to triggerRecommendations
      // setTimeout(() => {
      //   triggerRecommendations(userQuery);
      // }, 500);
    } else if (qualificationStage === 'initial') {
      // If user tries to type before selecting case type, remind them and re-show options
      addMessage("I understand you may have specific questions. To better assist you, please select the type of case you need help with from the options below:", false, [
        { value: 'personal-injury', text: 'Personal Injury' },
        { value: 'criminal-defense', text: 'Criminal Defense' },
        { value: 'divorce', text: 'Divorce' }
      ]);
    } else if (qualificationStage === 'caseType') {
      // If user tries to type before selecting location, remind them and re-show options
      addMessage("Thank you. Before we continue, please let me know if your case is in Kansas or Missouri:", false, [
        { value: 'kansas', text: 'Kansas' },
        { value: 'missouri', text: 'Missouri' },
        { value: 'other', text: 'Other State' }
      ]);
    }
  }
});
  
  inputField.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (!sendButton.disabled) {
        sendButton.click();
      }
    }
  });
  
  // Play video with sound when chat window opens
  chatBubble.addEventListener('click', () => {
  chatWindow.style.display = 'flex';
  chatBubble.style.display = 'none';
  hideNotification(); // Hide the notification when chat opens
  
  // Start qualification flow if it's the first time opening
  if (chatHistory.length === 0) {
    // Add video message as first message if not already added
    if (!videoAdded) {
      // Add the video message
      const videoMessage = createVideoMessage();
      messagesContainer.appendChild(videoMessage);
      videoAdded = true;
      
      // Wait a bit longer for video to start playing before showing first message
      setTimeout(() => {
        // Initial greeting and first qualification question
        addMessage("Hi there! I'm the virtual assistant here at Roth Davies. What type of case do you need help with?", false, [
          { value: 'personal-injury', text: 'Personal Injury' },
          { value: 'criminal-defense', text: 'Criminal Defense' },
          { value: 'divorce', text: 'Divorce' }
        ]);
      }, getRandomDelay(1000, 1500)); // Longer initial delay for first message
    }
  }
});
  
  closeButton.addEventListener('click', () => {
    chatWindow.style.display = 'none';
    chatBubble.style.display = 'flex';
    
    // Pause any videos that might be playing
    const videos = messagesContainer.querySelectorAll('video');
    videos.forEach(video => video.pause());
  });

   // Add your new window.addEventListener here
   window.addEventListener('load', () => {
  setTimeout(() => {
    // Show notification 
    showNotification();
  }, 2000);
});


})();
</script>
</body>
</html>
  
